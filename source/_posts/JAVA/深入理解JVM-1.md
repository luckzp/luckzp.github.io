---
title: 深入理解JVM(1)
date: 2019-11-11 13:17:40
tags: Java

---

### 1. Java程序如何跑起来的？

从虚拟机视角来看，编译完成的class文件会加载到JVM。

- 加载后的Java类会被存放于**方法区**中，创建class对象。
- 在运行过程中，每当调用进入一个Java方法，JVM会在当前的线程Java方法栈中生成一个栈帧，用以存放局部变量以及字节码的操作数。
- 当退出当前执行的方法时，JVM会弹出当前线程的当前栈帧，并将之舍弃。

**栈帧用于存放局部变量表，操作数栈，动态链接，方法出口信息等。**

BootStrap ClassLoader <JAVA_HOME>/lib

双亲委派模型：

1.防止类重复加载。

2.防止对JAVA核心API的篡改。

<!--more-->

### 2. JVM触发初始化的情况

- 当虚拟机启动时，初始化用户指定的主类。
- 当遇到用以新建目标类实例的new指令时，初始化new指令的目标类。
- 当遇到调用静态方法的指令时，初始化该静态方法所在的类。
- 当遇到访问静态字段额指令时，初始化该静态字段所在的类。
- 子类的初始化会触发父类的初始化。
- 如果一个接口定义了default方法，那么直接实现或间接实现该接口的类的初始化，会触发该接口的初始化。
- 使用反射API对某个类进行反射调用时，初始化这个类。
- 当初次调用MethodHandle实例时，初始化该MethodHandle指向的方法所在的类。

### 3. 在Hotspot虚拟机中，对象的内存布局。

对象在内存布局分为3块区域：对象头，实例数据和对齐填充。

对象头包含2部分，第一部分存储对象运行的数据如哈希码，GC分代年龄，锁状态标志，线程持有的锁，偏向线程ID，偏向时间戳，又称为**Mark Word**。另一部分是类型指针。

### 4. JMM与内存可见性

synchronized: 通过高级字节码monitor_enter和monitor_exit实现的。

volatile: 强制变量的赋值会强制刷新回主内存，强制变量的读取从主内存中重新加载。